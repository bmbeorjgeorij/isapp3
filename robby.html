<!DOCTYPE html>

<html>

<head>
    <link rel="stylesheet" type="text/css" href="robby.css">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>

    <script>
        osql.requireLogin();

        var me;

        var roomNames = [
            "ルーム1",
            "ルーム2",
            "ルーム3",
            "ルーム4"
        ];

        $(document).ready(function () {
            var fname = sessionStorage.getItem('fname');
            var lname = sessionStorage.getItem('lname');
            console.log(fname, lname);
            // ここでfnameとlnameを使用して必要な処理を行います
           
        });

        $(document).ready(async function () {
            me = await osql.getMe();
            document.getElementById('firstname').innerHTML = me.fname;
            document.getElementById('lastname').innerHTML = me.lname;
            setInterval(refreshRooms, 1000); // 1秒ごとに更新
            
        });

        async function updateRoom(roomId, roomName, fname) {
            var roomElement = document.getElementById(`room-${roomId}`);
            if (roomElement) {
                var fnameElement = roomElement.querySelector('.fname');
                var statusElement = roomElement.querySelector('.status');

                if (fnameElement) {
            fnameElement.textContent = fname;
        }

        if (statusElement) {
            if (fname === "") {
                statusElement.textContent = '空室';
            } else {
                statusElement.innerHTML = `<a href="room.html?roomId=${roomId}">入室</a>`;
            }
        }
    }
}

async function refreshRooms() {
    var sql = `
        select Users.id, Users.fname, Users.lname, Rooms.id AS roomId, Rooms.name
        from Users
        left join Rooms on Users.roomId = Rooms.id
        LIMIT 4`;
    var objects = await osql.connect(sql);
    console.log(objects);
    var html = '';
    html += '<table border="1">';
    for (var i = 0; i < roomNames.length; i++) {
        var roomId = i + 1;
        var roomName = roomNames[i];
        var fname = "";
        for (var j = 0; j < objects.length; j++) {
            var object = objects[j];
            if (object.roomId === roomId) {
                fname = object.fname;
                break;
            }
        }

        updateRoom(roomId, roomName, fname);
    }
}


    </script>

</head>

<body>
    <div style="text-align: center;">
        <h1>たけのこニョッキ </h1>
    <div class="player-info">
        ようこそ<span id="lastname"></span> <span id="firstname"></span>さん
        <a href="index.html">top</a>
        <hr>
    </div>
    <div class="center">
        <div id="rooms">
            <table class="room-table">
                <tr>
                    <th>ルーム名</th>
                    <th>参加人数</th>
                    <th>入室状況</th>
                </tr>
                <tr id="room-1">
                    <td>たけ1</td>
                    <td class="num-users"></td>
                    <td class="status"></td>
                </tr>
                <tr id="room-2">
                    <td>たけ2</td>
                    <td class="num-users"></td>
                    <td class="status"></td>
                </tr>
                <tr id="room-3">
                    <td>たけ3</td>
                    <td class="num-users"></td>
                    <td class="status"></td>
                </tr>
                <tr id="room-4">
                    <td>たけ4</td>
                    <td class="num-users"></td>
                    <td class="status"></td>
                </tr>
            </table>
        </div>
    </div>
    <div class="image-container">
        <img src="character_takenoko.png" alt="写真" width="300" height="200">
        <img src="character_takenoko.png" alt="写真" width="300" height="200">
        <img src="character_takenoko.png" alt="写真" width="300" height="200">
    </div>
</body>

</html>
