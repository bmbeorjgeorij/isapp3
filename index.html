<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="index.css">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>

    <script>
      osql.requireLogin();
  
      $(document).ready(async function() {
          var me = await osql.getMe();
          console.log(me);
          var username = me.fname.charAt(0); // ネームの最初の1文字をユーザーネームとして表示
          var roomId = await getAssignedRoomId();
          var sql = `
              INSERT INTO Users (id, fname, lname, roomId, username, entry_timestamp)
              VALUES ('${me.id}', '${me.fname}', '${me.lname}', ${roomId}, '${username}', CURRENT_TIMESTAMP)
              ON DUPLICATE KEY UPDATE
              roomId = IF(roomId = 0, ${roomId}, roomId), entry_timestamp = VALUES(entry_timestamp);
          `;
          await osql.connect(sql);
          document.getElementById('firstname').innerHTML = me.fname;
          document.getElementById('lastname').innerHTML = me.lname;
          document.getElementById('username').innerHTML = username;
      });
  
      var roomCounter = 1;

async function getAssignedRoomId() {
  var usedRoomIds = await getUsedRoomIds();
  var roomId = roomCounter;
  roomCounter = (roomCounter % 4) + 1;
  return roomId;
}

window.addEventListener('beforeunload', function() {
  localStorage.setItem('roomCounter', roomCounter);
});

window.addEventListener('load', function() {
  var storedRoomCounter = localStorage.getItem('roomCounter');
  if (storedRoomCounter !== null) {
    roomCounter = parseInt(storedRoomCounter);
  }
});
      // 修正後のコード
      async function getUsedRoomIds() {
          var sql = `
            SELECT DISTINCT roomId FROM Users ORDER BY entry_timestamp ASC;
          `;
          var result = await osql.connect(sql);
          var usedRoomIds = result.map(row => parseInt(row.roomId));
          return usedRoomIds;
      }
  
      function findAvailableRoomId(usedRoomIds) {
          var maxRoomId = 4; // 利用可能な最大のroomIdを指定
          var availableRoomIds = [];

          for (var roomId = 1; roomId <= maxRoomId; roomId++) {
              if (!usedRoomIds.includes(roomId)) {
                  availableRoomIds.push(roomId);
              }
          }

          if (availableRoomIds.length === 0) {
              return null; // 利用可能なroomIdがない場合はnullを返す
          }

          var index = usedRoomIds.length % availableRoomIds.length;
          return availableRoomIds[index];
      }
  
      function logout() {
          osql.logout();
      }
  
      function button1() {
          var fname = document.getElementById('firstname').innerHTML;
          var lname = document.getElementById('lastname').innerHTML;
          sessionStorage.setItem('fname', fname);
          sessionStorage.setItem('lname', lname);
          var linkurl = "robby.html";
          window.location.href = linkurl;
      }
  </script>

</head>

<body>
    <div style="text-align: center;">
        <h1>たけのこニョッキ </h1>
    </div>
    <div class="player-info">
        ようこそ<span id="lastname"></span> <span id="firstname"></span>さん
        <a href="javascript:logout()">logout</a>
    </div>
    <hr>
    <div style="text-align: center;">
        <p>ユーザー名: <span id="username"></span></p> <!-- ユーザー名を表示 -->
        <button onclick="button1()">ゲームを始める</button>
        <div class="image-container">
            <img src="character_takenoko.png" alt="写真" width="300" height="200">
            <img src="character_takenoko.png" alt="写真" width="300" height="200">
            <img src="character_takenoko.png" alt="写真" width="300" height="200">
        </div>
    </div>
</body>
</html>
