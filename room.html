<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="room.css">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
    <script>
        osql.requireLogin();

var me;
var roomId;
var selectedNumber = null;
var hasWon = false;
var countdownInterval = null;
var countdownSeconds = 30;
var gameStarted = false; // ゲーム開始フラグ

$(document).ready(async function () {
    me = await osql.getMe();
    document.getElementById('firstname').innerHTML = me.fname;
    document.getElementById('lastname').innerHTML = me.lname;
    var username = me.fname.charAt(0); // ネームの最初の1文字をユーザーネームとして表示
    document.getElementById('username').innerHTML = username;

    roomId = getCurrentRoomId();
    var sql = `SELECT * FROM Rooms WHERE id = ${roomId}`;
    var objects = await osql.connect(sql);
    var room = objects[0];
    document.getElementById('roomname').innerHTML = room.name;

    setInterval(refreshNumUsers, 1000); // 1秒ごとに参加人数を更新
    await refreshNumUsers();

    // ボタンをクリックしたときの処理を設定
    document.getElementById('selectNumberButton').addEventListener('click', selectNumber);

    // ゲーム開始時にデータをgameテーブルに挿入
    await insertGameData();

    // ゲーム開始の合図を受け取る
    await waitForGameStart();
    // ゲーム開始
    startGame();
});

// ゲーム開始の合図を待つ関数
async function waitForGameStart() {
    var sql = `SELECT COUNT(*) AS numUsers FROM Users WHERE roomId = ${roomId}`;
    var result = await osql.connect(sql);
    var numUsers = result[0].numUsers;

    // 参加人数が満たされるまでループ
    while (!gameStarted) {
        if (numUsers >= 2) {
            // ゲーム開始の合図を送信
            osql.broadcastMessage('gameStart', roomId);
            gameStarted = true;
        } else {
            // 参加人数が足りない場合は一定時間待機
            await sleep(1000); // 1秒待機
        }
    }
}

// ゲーム開始時の処理
function startGame() {
    // カウントダウン開始
    startCountdown();
}

// カウントダウン開始
function startCountdown() {
    var countdownElement = document.getElementById('countdown');
    countdownElement.innerHTML = countdownSeconds;

    countdownInterval = setInterval(function() {
        countdownSeconds--;
        countdownElement.innerHTML = countdownSeconds;

        if (countdownSeconds <= 0) {
            clearInterval(countdownInterval);
            evaluateResult();
        }
    }, 1000);
}

// 一定時間待機する関数
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// ゲームデータを挿入する関数
async function insertGameData() {
    var sql = `
        INSERT INTO game (roomId, userId, time)
        VALUES (${roomId}, '${me.id}', CURRENT_TIMESTAMP);
    `;
    await osql.connect(sql);
}

// ゲーム結果を評価する関数
function evaluateResult() {
    if (selectedNumber === null) {
        // 数字を選ばなかった場合は負けとする
        displayMessage('負け');
    } else if (hasWon) {
        displayMessage('勝ち');
    } else {
        displayMessage('負け');
    }
}

// メッセージの受信イベントを登録
osql.onMessage(function (event) {
    if (event.type === 'gameStart' && event.roomId === roomId) {
        // ゲーム開始の合図を受け取ったらゲーム開始
        startGame();
    }
});

// ゲームデータを取得する関数
async function getCurrentRoomId() {
    var sql = `
        SELECT roomId FROM Users WHERE id = '${me.id}';
    `;
    var result = await osql.connect(sql);
    if (result.length > 0) {
        return result[0].roomId;
    }
    return null;
}

// 参加人数を更新する関数
async function refreshNumUsers() {
    var sql = `
        SELECT COUNT(*) AS numUsers
        FROM Users
        WHERE roomId = ${roomId};
    `;
    var result = await osql.connect(sql);
    var numUsers = result[0].numUsers;
    document.getElementById('numUsers').innerHTML = `参加人数: ${numUsers}`;
}

// 数字を選択する関数
function selectNumber() {
    // 選択した数字を取得
    var numberInput = document.getElementById('numberInput');
    var selectedValue = parseInt(numberInput.value);

    // 入力値のバリデーション
    if (isNaN(selectedValue) || selectedValue < 1 || selectedValue > 5) {
        displayMessage('1から5までの数字を入力してください');
        return;
    }

    if (selectedNumber === null) {
        selectedNumber = selectedValue;

        // 選択した数字を表示
        displayMessage(`選択した数字: ${selectedNumber}`);

        // 選択した数字が他の参加者と被っていないかチ

checkIfNumberIsUnique();
}
}

// 数字が被っていないかチェックする関数
async function checkIfNumberIsUnique() {
var sql = `SELECT COUNT(*) AS count FROM Users WHERE roomId = ${roomId} AND id != '${me.id}' AND username = '${selectedNumber}';`;
var result = await osql.connect(sql);
var count = result[0].count;

if (count > 0) {
    // 数字が被っている場合は負けと表示
    displayMessage('負け');
} else {
    // 数字が被っていない場合は勝ちと表示
    hasWon = true;
    displayMessage('勝ち');
}

// カウントダウン終了後に勝敗を判定する
setTimeout(evaluateResult, countdownSeconds * 1000);
}

// メッセージを表示する関数
function displayMessage(message) {
document.getElementById('message').innerHTML = message;
}
    </script>
</head>
<body>
    <h1>ルーム<span id="roomname"></span></h1>
    <div class="player-info">
        ようこそ<span id="lastname"></span> <span id="firstname"></span>さん
        <a href="index.html">top</a>
    </div>
    <hr>
    <p>ユーザー名: <span id="username"></span></p>
    <div id="numUsers"></div>
    <br>
    <div>
        <label for="numberInput">数字を選んでください（1から5）: </label>
        <input type="number" id="numberInput" min="1" max="5">
        <button id="selectNumberButton">選択</button>
    </div>
    <div id="message"></div>
    <div>カウントダウン: <span id="countdown"></span> 秒</div>
    <div class="image-container">
        <img src="character_takenoko.png" alt="写真" width="300" height="200">
        <img src="character_takenoko.png" alt="写真" width="300" height="200">
        <img src="character_takenoko.png" alt="写真" width="300" height="200">
    </div>
</body>
</html>