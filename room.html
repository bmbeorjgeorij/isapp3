<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="room.css">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
    <script>
        osql.requireLogin();

        var me;
        var roomId;
        var selectedNumber = null;
        var hasWon = false;
        var countdownInterval = null;
        var countdownSeconds = 15;
        var gameStarted = false;
        var currentTurn = 1;
        var maxTurns = 6; // ã‚²ãƒ¼ãƒ ã‚’è¡Œã†æœ€å¤§ã‚¿ãƒ¼ãƒ³æ•°
        var isNumberSelected = false;

        $(document).ready(async function () {
            me = await osql.getMe();
            document.getElementById('firstname').innerHTML = me.fname;
            document.getElementById('lastname').innerHTML = me.lname;
            var username = me.fname.charAt(0);
            document.getElementById('username').innerHTML = username;
            roomId = getRoomIdFromURL();
            console.log(roomId);
            waitForGameStart();
            document.getElementById('roomname').innerHTML = roomId;
        });

        function getRoomIdFromURL() {
            var urlParams = new URLSearchParams(window.location.search);
            var roomId = urlParams.get('roomId');
            return roomId;
        }

        async function waitForGameStart() {
            var sql = `SELECT COUNT(*) AS numUsers FROM Users WHERE roomId = '${roomId}'`;
            var result = await osql.connect(sql);
            var deleteAnswersSql = `DELETE FROM answer WHERE id = '${me.id}'`;
            await osql.connect(deleteAnswersSql);
            var numUsers = result[0].numUsers;
            if (numUsers >= 2) {
                gameStarted = true;

                displayMessage('ã‚²ãƒ¼ãƒ é–‹å§‹ã¾ã§');
                var sql = `SELECT turn FROM game WHERE roomId = '${roomId}'`;
                var result = await osql.connect(sql);
                if (result.length > 0) {
                    currentTurn = result[0].turn;
                } else {
                    // game ãƒ†ãƒ¼ãƒ–ãƒ«ã«è©²å½“ã™ã‚‹ roomId ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°ãŸã«è¿½åŠ 
                    var insertGameSql = `INSERT INTO game (roomId, turn) VALUES ('${roomId}', 1)`;
                    await osql.connect(insertGameSql);
                }
                document.getElementById('turnNumber').innerHTML = currentTurn;

                if (currentTurn < maxTurns) {
                    startCountdown();
                    displayNumberSelection();
                } else {
                    endGame();
                }
            } else {
                setTimeout(waitForGameStart, 1000);
            }
        }

        function getCurrentTurn() {
            var turnSql = `SELECT turn FROM game WHERE roomId = '${roomId}'`;
            osql.connect(turnSql, function (turnResult) {
                currentTurn = turnResult[0].turn;
                document.getElementById('turnNumber').innerHTML = currentTurn;
            });
        }

        function startCountdown() {
            var countdownElement = document.getElementById('countdown');
            countdownElement.innerHTML = countdownSeconds;

            countdownInterval = setInterval(function () {
    countdownSeconds--;

    if (countdownSeconds <= 0) {
        clearInterval(countdownInterval);
        countdownElement.innerHTML = '0';
        evaluateResult();
    } else {
        countdownElement.innerHTML = countdownSeconds;
    }
}, 1000);
        }

        async function selectNumberButton() {
            var selectedNumber = parseInt(document.getElementById('numberInput').value);
            console.log(selectedNumber);
            var sql = `INSERT INTO answer (id, answer) VALUES ('${me.id}', ${selectedNumber})`;
            await osql.connect(sql);
            // é¸æŠæ¸ˆã¿ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤ºã—ã€æ•°å­—ã‚’é¸æŠæ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã™
            document.getElementById('selectedComment').innerHTML = `æ•°å­— ${selectedNumber} ã‚’é¸æŠæ¸ˆã¿`;

            isNumberSelected = true;

    // ã€Œæ±ºå®šã€ï¼ˆSelectï¼‰ãƒœã‚¿ãƒ³ã‚’é¸æŠã—ãŸå¾Œã«ç„¡åŠ¹åŒ–ã—ã¾ã™
    document.getElementById('selectButton').disabled = true;
}

        async function evaluateResult() {
            var selectedNumber = parseInt(document.getElementById('numberInput').value);
            console.log(selectedNumber);

            if (isNaN(selectedNumber)) {
                displayMessage('å€¤ãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„ã®ã§è² ã‘');
            } else {
                var resultSql = `
                    SELECT COUNT(*) AS count
                    FROM Users u
                    INNER JOIN answer a ON u.id = a.id
                    WHERE u.roomId = '${roomId}' AND a.answer = ${selectedNumber} AND u.id <> '${me.id}'
                `;
                var result = await osql.connect(resultSql);
                var matchCount = result[0].count;

                if (matchCount > 0) {
            displayMessage('ä»–ã®å‚åŠ è€…ã¨ã‹ã¶ã£ã¦ã„ã‚‹ã®ã§è² ã‘');
        } else {
            // Check if the game has started or not
            if (gameStarted) {
                displayMessage('ğŸ‰ä»–ã®å‚åŠ è€…ã¨ã‹ã¶ã£ã¦ã„ãªã„ã®ã§å‹ã¡ğŸ‰');
            } else{
                displayMessage('ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        }
    }
    var allResultSql = `
        SELECT u.username, a.answer
        FROM Users u
        INNER JOIN answer a ON u.id = a.id
        WHERE u.roomId = '${roomId}'
    `;
            var allResult = await osql.connect(allResultSql);

            var resultTable = document.createElement('table');
    resultTable.innerHTML = `
        <tr>
            <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
            <th>é¸æŠã—ãŸæ•°å­—</th>
        </tr>
    `;

    for (var i = 0; i < allResult.length; i++) {
        resultTable.innerHTML += `
            <tr>
                <td>${allResult[i].username}</td>
                <td>${allResult[i].answer}</td>
            </tr>
        `;
    }

    var resultContainer = document.getElementById('result');
    resultContainer.innerHTML = '';
    resultContainer.appendChild(resultTable);
            // ã‚²ãƒ¼ãƒ å†é–‹ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('restartButton').disabled = false;

            // ã‚¿ãƒ¼ãƒ³æ•°ãŒmaxTurnsä»¥ä¸Šã«ãªã£ãŸã‚‰ã‚²ãƒ¼ãƒ çµ‚äº†
            if (currentTurn >= maxTurns) {
                endGame();
            }
        }

        function displayMessage(message) {
            document.getElementById('message').innerHTML = message;
        }

        function displayNumberSelection() {
            var numberInput = document.getElementById('numberInput');
            numberInput.setAttribute('min', '1');
            numberInput.setAttribute('max', '5');
        }

        async function restartGame() {
    var deleteAnswersSql = `DELETE FROM answer WHERE id = '${me.id}'`;
    await osql.connect(deleteAnswersSql);

     // é¸æŠæ¸ˆã¿ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¶ˆå»ã—ã€æ•°å­—ãŒæœªé¸æŠã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã™
     document.getElementById('selectedComment').innerHTML = '';
    isNumberSelected = false;

    // ã‚¿ãƒ¼ãƒ³æ•°ã‚’æ›´æ–°
    currentTurn++;
    var updateTurnSql = `UPDATE game SET turn = ${currentTurn} WHERE roomId = '${roomId}'`;
    await osql.connect(updateTurnSql);

    // ã‚¿ãƒ¼ãƒ³æ•°ã‚’å†è¡¨ç¤º
    document.getElementById('turnNumber').innerHTML = currentTurn;

    countdownSeconds = 15;  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ç§’æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
    startCountdown();
    document.getElementById('selectButton').disabled = false;
    document.getElementById('result').innerHTML = '';

    // ã‚²ãƒ¼ãƒ å†é–‹ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    document.getElementById('restartButton').disabled = 'none';

    // ã‚¿ãƒ¼ãƒ³æ•°ãŒmaxTurnsä»¥ä¸Šã«ãªã£ãŸã‚‰ã‚²ãƒ¼ãƒ çµ‚äº†
    if (currentTurn >= maxTurns) {
        endGame();
    }else {
        // Game hasn't started yet, so reset the message to "ã‚²ãƒ¼ãƒ é–‹å§‹ã¾ã§"
        displayMessage('ã‚²ãƒ¼ãƒ çµæœé–‹ç¤ºã¾ã§');
}}

       // æ–°ãŸãªã‚¿ãƒ¼ãƒ³æƒ…å ±ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
       async function updateTurnOnServer(turn) {
            var updateTurnSql = `UPDATE game SET turn = ${turn} WHERE roomId = '${roomId}'`;
            await osql.connect(updateTurnSql);
        }

        // ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ãŸå¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚å†ã³ã‚¿ãƒ¼ãƒ³1ã‹ã‚‰ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        window.addEventListener('beforeunload', function() {
            updateTurnOnServer(1);
        });

        async function endGame() {
            // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            displayMessage('ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¾ã—ãŸ');
            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã¨æ•°å­—é¸æŠãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            document.getElementById('countdown').style.display = 'none';
            document.getElementById('numberInput').style.display = 'none';
            document.getElementById('selectButton').style.display = 'none';
            // ã‚²ãƒ¼ãƒ å†é–‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            document.getElementById('restartButton').style.display = 'none';
            document.getElementById('result').style.display = 'none';
            document.getElementById('kauntodaun').style.display = 'none';
            document.getElementById('l').style.display = 'none';
            document.getElementById('turnNumber').style.display = 'none';
            document.getElementById('w').style.display = 'none';
            var iti= `delete from answer where answer = '1'`;
            var ni= `delete from answer where answer = '2'`;
            var san= `delete from answer where answer = '3'`;
            var yon= `delete from answer where answer = '4'`;
            var go= `delete from answer where answer = '5'`;
            await osql.connect(iti);
            await osql.connect(ni);
            await osql.connect(san);
            await osql.connect(yon);
            await osql.connect(go);

        }
    </script>
</head>
<body>
    <h1>ãƒ«ãƒ¼ãƒ <span id="roomname"></span></h1>
    <div class="player-info">
        ã‚ˆã†ã“ã<span id="lastname"></span> <span id="firstname"></span>ã•ã‚“
        <a href="index.html">top</a>
    </div>
    <hr>
    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼å: <span id="username"></span></p>
    <p id="w">ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³: <span id="turnNumber"></span></p>
    <div id="numUsers"></div>
    <br>
    <div id="l">
        <label for="numberInput">æ•°å­—ã‚’é¸ã‚“ã§æ±ºå®šãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­ï¼ˆ1ã‹ã‚‰5ï¼‰: </label>
        <input type="number" id="numberInput">
        <button id="selectButton" onclick="selectNumberButton()">æ±ºå®š</button>
        <div id="selectedComment"></div>
    </div>
    <div id="message"></div>
    <div id="kauntodaun">ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³: <span id="countdown"></span> ç§’</div>
    <div id="result">
</div>
    <div id="gameControls">
        <button id="restartButton" onclick="restartGame()" disabled>ã‚‚ã†ä¸€åº¦éŠã¶</button>
    </div>
    <div class="image-container">
        <img src="character_takenoko.png" alt="å†™çœŸ" width="300" height="200">
        <img src="character_takenoko.png" alt="å†™çœŸ" width="300" height="200">
        <img src="character_takenoko.png" alt="å†™çœŸ" width="300" height="200">
    </div>
</body>
</html>
    
    
    