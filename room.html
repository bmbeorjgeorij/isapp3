<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="room.css">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
    <script>
        osql.requireLogin();



var me;
var roomId;
var selectedNumber = null;
var hasWon = false;
var countdownInterval = null;
var countdownSeconds = 15;
var gameStarted = false; // ゲーム開始フラグ

$(document).ready(async function () {
    me = await osql.getMe();
    document.getElementById('firstname').innerHTML = me.fname;
    document.getElementById('lastname').innerHTML = me.lname;
    var username = me.fname.charAt(0); // ネームの最初の1文字をユーザーネームとして表示
    document.getElementById('username').innerHTML = username;
    roomId = getRoomIdFromURL();
    // ゲーム開始の合図を待つ
    console.log(roomId)
    waitForGameStart();
    document.getElementById('roomname').innerHTML = roomId;
    

});
function getRoomIdFromURL() {
    var urlParams = new URLSearchParams(window.location.search);
    var roomId = urlParams.get('roomId');
    return roomId;
}


// ゲーム開始の合図を待つ関数
async function waitForGameStart() {
    var sql = `SELECT COUNT(*) AS numUsers FROM Users WHERE roomId = '${roomId}'`;
    var result = await osql.connect(sql);
    var numUsers = result[0].numUsers;

    // 参加人数が2人以上の場合、ゲームを開始する
    if (numUsers >=2) {
        gameStarted = true;
        displayMessage('ゲーム開始です');
        startCountdown();
        displayNumberSelection(); // 数字選択の表示
    } else {
        // 参加人数が足りない場合は一定時間後に再試行する
        setTimeout(waitForGameStart, 1000); // 1秒後に再試行
    }
}

// カウントダウン開始
function startCountdown() {
    var countdownElement = document.getElementById('countdown');
    countdownElement.innerHTML = countdownSeconds;

    countdownInterval = setInterval(function () {
        countdownSeconds--;
        countdownElement.innerHTML = countdownSeconds;

        if (countdownSeconds <= 0) {
            clearInterval(countdownInterval);
            evaluateResult();
        }
    }, 1000);
}


// 数字選択の表示
async function selectNumberButton() {
    var selectedNumber = parseInt(document.getElementById('numberInput').value);
    console.log(selectedNumber);
    var sql = `INSERT INTO answer (id, answer) VALUES ('${me.id}', ${selectedNumber})`;
    await osql.connect(sql);
    
    // ボタンを無効化する
    document.getElementById('selectButton').disabled = true;
}
//ゲーム結果を評価する関数
async function evaluateResult() {
    var selectedNumber = parseInt(document.getElementById('numberInput').value);
    console.log(selectedNumber);

    if (isNaN(selectedNumber)) {
        // 数字が入力されていない場合は負けとする
        displayMessage('値が入力されていないので負け');
    } else {
        // 自分の選択結果と他の選択結果を比較
        var resultSql = `
            SELECT answer FROM answer WHERE roomId = '${roomId}' AND id <> '${me.id}';
        `;
        var result = await osql.connect(resultSql);

        var match = false;
        for (var i = 0; i < result.length; i++) {
            if (result[i].answer === selectedNumber) {
                match = true;
                break;
            }
        }

        if (match) {
            displayMessage('他の参加者とかぶっているので負け');
        } else {
            displayMessage('他の参加者とかぶっていないので勝ち');
        }
    }

    // 全員の選択結果を取得して表示
    var allResultSql = `
        SELECT u.fname, u.lname, a.answer
        FROM Users u
        INNER JOIN answer a ON u.id = a.id
        WHERE u.roomId = '${roomId}';
    `;
    var allResult = await osql.connect(allResultSql);

    var resultText = '<h2>結果</h2><ul>';
    for (var i = allResult.length - 1; i >= 0; i--) {
        resultText += `<li>${allResult[i].fname} ${allResult[i].lname}：${allResult[i].answer}</li>`;
    }
    resultText += '</ul>';
    document.getElementById('result').innerHTML = resultText;
}
    

// メッセージを表示する関数
function displayMessage(message) {
    document.getElementById('message').innerHTML = message;
}
</script>
</head>
<body>
    <h1>ルーム<span id="roomname"></span></h1>
    <div class="player-info">
        ようこそ<span id="lastname"></span> <span id="firstname"></span>さん
        <a href="index.html">top</a>
    </div>
    <hr>
    <p>ユーザー名: <span id="username"></span></p>
    <div id="numUsers"></div>
    <br>
    <div>
        <label for="numberInput">数字を選んでください（1から5）: </label>
        <input type="number" id="numberInput" min="1" max="10">
        <button id="selectButton" onclick="selectNumberButton()">選択</button>
    </div>
    <div id="message"></div>
    <div>カウントダウン: <span id="countdown"></span> 秒</div>
    <div id="result"></div>
    <div class="image-container">
        <img src="character_takenoko.png" alt="写真" width="300" height="200">
        <img src="character_takenoko.png" alt="写真" width="300" height="200">
        <img src="character_takenoko.png" alt="写真" width="300" height="200">
    </div>
</body>
</html>