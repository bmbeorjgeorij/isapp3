<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
    <script>
        osql.requireLogin();

var me;
var roomId = osql.getParam('roomId');
var selectedNumber = null;
var hasWon = false;

$(document).ready(async function () {
    me = await osql.getMe();
    document.getElementById('firstname').innerHTML = me.fname;
    document.getElementById('lastname').innerHTML = me.lname;

    var sql = `select * from Rooms where id = ${roomId};`;
    var objects = await osql.connect(sql);

    var room = objects[0];
    document.getElementById('roomname').innerHTML = room.name;

    setInterval(refreshNumUsers, 1000); // 1秒ごとに参加人数を更新
    await refreshNumUsers();
});

async function refreshNumUsers() {
            var sql = `
    SELECT Rooms.name, COUNT(*) AS numUsers
    FROM Rooms
    LEFT JOIN Users ON Rooms.id = Users.roomId
    WHERE Rooms.id = ${roomId} OR (Rooms.id IS NULL AND Users.id = '${me.id}')
    GROUP BY Rooms.id;
`;
var result = await osql.connect(sql);
var room = result[0];
document.getElementById('roomname').innerHTML = room.name;
document.getElementById('numUsers').innerHTML = `参加人数: ${room.numUsers}`;
        }


function selectNumber() {
    // すでに数字が選択されているかチェック
    if (selectedNumber !== null) {
        displayMessage('すでに数字が選択されています');
        return;
    }

    // 参加者が選択した数字を取得
    var selectedNumber = parseInt(document.getElementById('numberInput').value);

    // 入力値のバリデーション
    if (isNaN(selectedNumber) || selectedNumber < 1 || selectedNumber > 5) {
        displayMessage('1から5までの数字を入力してください');
        return;
    }

    // 選択した数字を表示
    displayMessage(`選択した数字: ${selectedNumber}`);

    // 選択した数字が他の参加者と被っていないかチェック
    checkIfNumberIsUnique(selectedNumber);
}

async function checkIfNumberIsUnique(selectedNumber) {
    var sql = `
        SELECT COUNT(*) AS count
        FROM Users
        WHERE roomId = ${roomId}
        AND username = '${selectedNumber}';
    `;
    var result = await osql.connect(sql);
    var count = result[0].count;

    if (count > 0) {
        // 数字が被っている場合は負けと表示
        displayMessage('負け');
    } else {
        // 数字が被っていない場合は勝ちと表示
        hasWon = true;
        displayMessage('勝ち');
    }
}

function displayMessage(message) {
    document.getElementById('message').innerHTML = message;
}
    </script>
</head>
<body>
    <h1>room <span id="roomname"></span></h1>
<div style="text-align: right;">
    ようこそ<span id="lastname"></span> <span id="firstname"></span>さん
    <a href="index.html">top</a>
</div>
<hr>
<div id="numUsers"></div>
<br>
<div>
    <label for="numberInput">数字を選んでください（1から5）: </label>
    <input type="number" id="numberInput" min="1" max="5">
    <button id="selectNumberButton">選択</button>
</div>
<div id="message"></div>
</body>
</html>